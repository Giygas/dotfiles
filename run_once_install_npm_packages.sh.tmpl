#!/usr/bin/env bash
{{ if or (eq .chezmoi.os "darwin") (eq .chezmoi.os "linux") }}

# Exit immediately on error
set -e

# Ensure npm is available
if ! command -v npm &>/dev/null; then
  echo "❌ npm is not installed. Skipping global npm package install."
  exit 0
fi

echo "📦 Installing global npm packages..."

# List of global npm packages you want installed
packages=(
  "@compodoc/live-server"
  "@olrtg/emmet-language-server"
  "@tailwindcss/language-server"
  "corepack@0.34.0"
  "eas-cli@16.19.1"
  "npm"
  "pnpm@latest"
  "svelte-language-server"
)

# Ensure npm global installs don't require sudo
NPM_GLOBAL_PREFIX="${HOME}/.npm-global"

if [ "$(npm config get prefix)" != "$NPM_GLOBAL_PREFIX" ]; then
  echo "🔧 Setting npm global prefix to $NPM_GLOBAL_PREFIX"
  npm config set prefix "$NPM_GLOBAL_PREFIX"
  mkdir -p "$NPM_GLOBAL_PREFIX/bin"
  export PATH="$NPM_GLOBAL_PREFIX/bin:$PATH"
  echo 'export PATH="$HOME/.npm-global/bin:$PATH"' >> ~/.bashrc
fi

# Install each package if not already installed
for pkg in "${packages[@]}"; do
  name=$(echo "$pkg" | cut -d'@' -f1)
  if npm list -g --depth=0 "$name" &>/dev/null; then
    echo "✅ $pkg already installed."
  else
    echo "⬇️ Installing $pkg..."
    npm install -g "$pkg"
  fi
done

echo "🎉 Global npm packages setup complete."

{{ else }}

echo "Windows env detected, good luck."

{{ end }}

