#!/usr/bin/env bash
set -e
HOME_DIR="{{ .chezmoi.homeDir }}"

if [ -f "$HOME_DIR/.zshrc" ]; then
    echo "Configuring PATH in .zshrc..."

    # -------------------------------
    # Zsh aliases and theme
    # -------------------------------

    if ! grep -q "EDITOR=nvim" "$HOME_DIR/.zshrc"; then
        echo 'EDITOR=nvim' >> "$HOME_DIR/.zshrc"
        echo "✅ Added EDITOR to PATH"
    fi

    if ! grep -q ".zsh_aliases" "$HOME_DIR/.zshrc"; then
        echo '. $HOME/.zsh_aliases' >> "$HOME_DIR/.zshrc"
        echo "✅ Added zsh_aliases to PATH"
    fi

    if ! grep -q ".zsh_theme" "$HOME_DIR/.zshrc"; then
        echo '. $HOME/.zsh_theme' >> "$HOME_DIR/.zshrc"
        echo "✅ Added zsh_theme to PATH"
    fi

    # Fzf integration
    if ! grep -q "plugins=.*fzf" "$HOME_DIR/.zshrc"; then
        # Add fzf to existing plugins list
        sed -i '/^plugins=/ s/)/ fzf)/' "$HOME_DIR/.zshrc"
        echo "✅ Added fzf to plugins in .zshrc"
    else
        echo "✅ fzf already present in plugins"
    fi


    # Add zsh-autosuggestions and zsh-syntax-highlighting
    if ! grep -q "zsh-autosuggestions\|zsh-syntax-highlighting" "$HOME_DIR/.zshrc"; then
        # Add plugins to existing list (preserves current plugins)
        sed -i '/^plugins=/ s/)/ zsh-autosuggestions zsh-syntax-highlighting)/' "$HOME_DIR/.zshrc"
        echo "✅ Added zsh plugins to .zshrc"
    else
        echo "✅ zsh plugins already present in .zshrc"
    fi

    # Add go to PATH
    if ! grep -q "go/bin" "$HOME_DIR/.zshrc"; then
        echo 'export PATH=$PATH:/usr/local/go/bin' >> "$HOME_DIR/.zshrc"
        echo 'export PATH=$PATH:$HOME/go/bin' >> "$HOME_DIR/.zshrc"
    fi

    # Add .local/bin
    # First, uncomment any existing commented PATH lines
    if grep -q "^# export PATH=.*\.local/bin" "$HOME_DIR/.zshrc"; then
        # Get the line number and uncomment it
        LINE_NUM=$(grep -n "^# export PATH=.*\.local/bin" "$HOME_DIR/.zshrc" | cut -d: -f1 | head -1)
        if [ -n "$LINE_NUM" ]; then
            sed -i "${LINE_NUM}s/^# //" "$HOME_DIR/.zshrc"
            echo "✅ Uncommented existing PATH line (line $LINE_NUM)"
        fi
    fi

    ## Using the script in aliases right now
    ## # Add .local/scripts
    ## if ! grep -q ".local/scripts" "$HOME_DIR/.zshrc"; then
    ##     echo 'export PATH="$HOME/.local/scripts:$PATH"' >> "$HOME_DIR/.zshrc"
    ##     echo "✅ Added .local/scripts to PATH"
    ## fi

    # Add opencode to PATH
    if ! grep -q ".opencode/bin" "$HOME_DIR/.zshrc"; then
        echo 'export PATH=/home/dev/.opencode/bin:$PATH' >> "$HOME_DIR/.zshrc"
    fi

    # Add nvm to PATH
    if ! grep -q "NVM_DIR" "$HOME_DIR/.zshrc"; then
        echo 'export NVM_DIR="$HOME/.nvm"' >> "$HOME_DIR/.zshrc"
        echo '[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"' >> "$HOME_DIR/.zshrc"
        echo '[ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"' >> "$HOME_DIR/.zshrc"
        echo "✅ Added NVM to .zshrc"
    fi
 
    # Make dev.sh executable
    if [ -f "$HOME_DIR/.local/scripts/dev.sh" ]; then
        chmod +x "$HOME_DIR/.local/scripts/dev.sh"
        echo "✅ Made dev.sh executable"
    fi

    # Then check if active PATH exists and add if missing
    if ! grep -q "^export PATH=.*\.local/bin" "$HOME_DIR/.zshrc"; then
        echo "export PATH=\$HOME/bin:\$HOME/.local/bin:/usr/local/bin:\$PATH" >> "$HOME_DIR/.zshrc"
        echo "✅ Added .local/bin to PATH"
    else
        echo "✅ .local/bin already configured in PATH"
    fi

    # Add the nvim bin to path
    if ! grep -q "/opt/nvim-linux-x86_64/bin" "$HOME_DIR/.zshrc"; then
        echo 'export PATH="$PATH:/opt/nvim-linux-x86_64/bin"' >> "$HOME_DIR/.zshrc"
    fi

    # Add pnpm
    if ! grep -q "pnpm" "$HOME_DIR/.zshrc"; then
        echo 'export PNPM_HOME="$HOME/.local/share/pnpm"' >> "$HOME_DIR/.zshrc"
        echo 'export PATH="$PNPM_HOME:$PATH"' >> "$HOME_DIR/.zshrc"
        echo "✅ Added pnpm to PATH"
    fi

    # Add npm-global (if still needed)
    if ! grep -q ".npm-global/bin" "$HOME_DIR/.zshrc"; then
        echo 'export PATH="$HOME/.npm-global/bin:$PATH"' >> "$HOME_DIR/.zshrc"
        echo "✅ Added npm-global to PATH"
    fi

    # Add zoxide
    if ! grep -q "zoxide init zsh" "$HOME_DIR/.zshrc"; then
        echo "eval "$(zoxide init zsh)" >> "$HOME_DIR/.zshrc"
        echo "✅ Added npm-global to PATH"
    fi

    # Set zsh as default shell
    if [ "$SHELL" != *"zsh"* ]; then
        echo "Setting zsh as default shell..."
        if command -v zsh >/dev/null 2>&1; then
            chsh -s "$(command -v zsh)" || echo "󰀪 Could not change shell (may require sudo or
    different permissions)"
            echo "󰀯 Restart your shell or run 'exec zsh' to use zsh"
        else
            echo "󰀪 zsh is not installed"
        fi
    fi

else
    echo "❌ .zshrc not found - cannot configure PATH"
fi
