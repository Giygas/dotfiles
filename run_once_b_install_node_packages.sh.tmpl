#!/usr/bin/env bash
{{ if or (eq .chezmoi.os "darwin") (eq .chezmoi.os "linux") }}

set -e

echo "ğŸ“¦ Setting up Node.js development environment..."

# Determine OS and home directory
OS="{{ .chezmoi.os }}"
HOME_DIR="{{ .chezmoi.homeDir }}"

echo "OS detected: $OS"
echo "Home directory: $HOME_DIR"

# -------------------------------
# Install pnpm (cross-platform)
# -------------------------------
if ! command -v pnpm &>/dev/null; then
    echo "Installing pnpm..."
    curl -fsSL https://get.pnpm.io/install.sh | sh -
    
    # Set up pnpm environment for current script session
    export PNPM_HOME="$HOME_DIR/.local/share/pnpm"
    export PATH="$PNPM_HOME:$PATH"
    
    echo "âœ… Installed pnpm"
else
    echo "âœ… pnpm already installed"
    # Ensure pnpm environment is set for current session
    export PNPM_HOME="$HOME_DIR/.local/share/pnpm"
    export PATH="$PNPM_HOME:$PATH"
fi

# -------------------------------
# Install OpenCode (cross-platform)
# -------------------------------
if ! command -v opencode &>/dev/null; then
    echo "Installing OpenCode..."
    curl -fsSL https://opencode.ai/install | bash -
else
    echo "âœ… OpenCode already installed"
fi

# -------------------------------
# Install Node.js tools with pnpm
# -------------------------------
if command -v pnpm &>/dev/null; then
    echo "Installing Node.js tools with pnpm..."
    
    # Combined package list from both dev tools and npm packages scripts
    pnpm add -g \
        @compodoc/live-server \
        @olrtg/emmet-language-server \
        @tailwindcss/language-server \
        corepack@0.34.0 \
        eas-cli@16.19.1 \
        prettier \
        @fsouza/prettierd \
        typescript-language-server \
        yaml-language-server \
        markdownlint-cli \
        svelte-language-server \
        @supabase/supabase-js
    
    echo "âœ… Installed Node.js tools with pnpm"
else
    echo "âŒ pnpm not available, cannot install Node.js tools"
    exit 1
fi


echo "ğŸ‰ Node.js development environment setup complete!"

{{ else }}

echo "Windows env detected, good luck."

{{ end }}
