#!/usr/bin/env bash
{{ if or (eq .chezmoi.os "darwin") (eq .chezmoi.os "linux") }}
set -e

ask_install_dev_tools() {
    printf "Do you want to install node tools? (y/n)"
    read -n 1 -r response
    echo  # Add newline after input for clean formatting
    if [[ "$response" =~ ^([yY])$ ]]; then
        echo "Installing node tools..."
        return 0  # Continue with installation
    else
        echo "Skipping node tools installation."
        return 1  # Skip installation
    fi
}

if ask_install_dev_tools; then

    echo "ğŸ“¦ Setting up Node.js development environment..."

    # Determine OS and home directory
    OS="{{ .chezmoi.os }}"
    HOME_DIR="{{ .chezmoi.homeDir }}"

    echo "OS detected: $OS"
    echo "Home directory: $HOME_DIR"

    # Install nvim-tree-sitter with npm (otherwise it does not work)
    npm install -g tree-sitter-cli

    # -------------------------------
    # Install pnpm (cross-platform)
    # -------------------------------
    if ! command -v pnpm &>/dev/null; then
        echo "Installing pnpm..."
        curl -fsSL https://get.pnpm.io/install.sh | sh -
        
        # Set up pnpm environment for current script session
        export PNPM_HOME="$HOME_DIR/.local/share/pnpm"
        export PATH="$PNPM_HOME:$PATH"
        
        echo "âœ… Installed pnpm"
    else
        echo "âœ… pnpm already installed"
        # Ensure pnpm environment is set for current session
        export PNPM_HOME="$HOME_DIR/.local/share/pnpm"
        export PATH="$PNPM_HOME:$PATH"
    fi

    # -------------------------------
    # Install Node.js tools with pnpm
    # -------------------------------
    if command -v pnpm &>/dev/null; then
        echo "Installing Node.js tools with pnpm..."
        
        # Combined package list from both dev tools and npm packages scripts
        pnpm add -g \
            @compodoc/live-server \
            @olrtg/emmet-language-server \
            @tailwindcss/language-server \
            jsonlint \
            corepack@0.34.0 \
            eas-cli@16.19.1 \
            prettier \
            @fsouza/prettierd \
            typescript-language-server \
            yaml-language-server \
            markdownlint-cli \
            tree-sitter \
            svelte-language-server \
            neovim \
            @supabase/supabase-js
        
        echo "âœ… Installed Node.js tools with pnpm"
    else
        echo "âŒ pnpm not available, cannot install Node.js tools"
        exit 1
    fi


    echo "ğŸ‰ Node.js development environment setup complete!"
else
    echo "â­ï¸Skipping node tools installation"
fi

{{ else }}

echo "Windows env detected, good luck."

{{ end }}
