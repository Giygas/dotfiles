#!/usr/bin/env bash
set -e

echo "🔧 Starting dev environment setup..."

# -------------------------------
# Determine OS and home directory
# -------------------------------
OS="{{ .chezmoi.os }}"
HOME_DIR="{{ .chezmoi.homeDir }}"
USER_NAME=$(whoami)

echo "OS detected: $OS"
echo "User: $USER_NAME"
echo "Home directory: $HOME_DIR"

# -------------------------------
# macOS setup
# -------------------------------
if [[ "$OS" == "darwin" ]]; then
    echo "📦 Setting up macOS dev environment..."

    # Ensure Homebrew is installed
    if ! command -v brew &>/dev/null; then
        echo "Installing Homebrew..."
        /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    fi

    echo "Installing Homebrew packages..."
    brew update
    brew install \
        black cocoapods colima docker efm-langserver fd ffmpeg flyctl fzf ghostscript \
        git git-filter-repo gnupg go htop icu4c@76 imagemagick isort jsonlint lazygit \
        lua-language-server markdownlint-cli marksman mongosh neovim pandoc pinentry-mac pipx \
        plow postgresql@17 powerlevel10k prettier prettierd pyright python-lsp-server python@3.13 \
        qemu ranger ripgrep ruff visidata sst/tap/opencode stylua supabase/tap/supabase tmux \
        tursodatabase/tap/turso typescript-language-server uvicorn vale watchman wrk yadm \
        yaml-language-server yt-dlp zoxide zsh
fi

# -------------------------------
# Linux (Ubuntu) setup
# -------------------------------
if [[ "$OS" == "linux" ]]; then
    echo "📦 Setting up Linux dev environment (user: $USER_NAME)..."

    # Check for essential system packages
    REQUIRED=("git" "python3" "pip3" "curl")
    MISSING=()
    for pkg in "${REQUIRED[@]}"; do
        if ! command -v "$pkg" &>/dev/null; then
            MISSING+=("$pkg")
        fi
    done

    if [ ${#MISSING[@]} -ne 0 ]; then
        echo "⚠️  The following system packages are missing: ${MISSING[*]}"
        echo "Please install them first. Example for Ubuntu/Debian:"
        echo "sudo apt update && sudo apt install -y ${MISSING[*]}"
        exit 1
    fi

    # Install Node.js 20+ if needed
    if ! command -v node &>/dev/null || [[ $(node -v | cut -d'v' -f2 | cut -d'.' -f1) -lt 18 ]]; then
        echo "Installing Node.js 20..."
        
        # Remove existing Node.js installation to avoid conflicts
        echo "Removing existing Node.js installation..."
        sudo apt-get remove -y nodejs npm libnode-dev || true
        sudo apt-get autoremove -y || true
        
        # Add NodeSource repository
        curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
        
        # Install Node.js 20
        sudo apt-get install -y nodejs
        
        # Clean up any remaining conflicts
        sudo apt-get autoremove -y || true
    fi

    # Install pnpm
    if ! command -v pnpm &>/dev/null; then
        echo "Installing pnpm..."
        
        # Install pnpm using npm (more reliable in containers)
        npm install -g pnpm
        
        # Set up pnpm environment
        export PNPM_HOME="$HOME_DIR/.local/share/pnpm"
        export PATH="$PNPM_HOME:$PATH"
        
        # Run pnpm setup to create global bin directory
        pnpm setup
        
        # Add to shell rc files
        echo 'export PNPM_HOME="$HOME/.local/share/pnpm"' >> "$HOME_DIR/.bashrc"
        echo 'export PATH="$PNPM_HOME:$PATH"' >> "$HOME_DIR/.bashrc"
        echo 'export PNPM_HOME="$HOME/.local/share/pnpm"' >> "$HOME_DIR/.zshrc"
        echo 'export PATH="$PNPM_HOME:$PATH"' >> "$HOME_DIR/.zshrc"
        
        # Source the pnpm environment
        if [ -f "$HOME_DIR/.local/share/pnpm/pnpm" ]; then
            source "$HOME_DIR/.local/share/pnpm/pnpm" || true
        fi
    else
        # Ensure pnpm environment is set even if already installed
        export PNPM_HOME="$HOME_DIR/.local/share/pnpm"
        export PATH="$PNPM_HOME:$PATH"
    fi

    # Local bin setup
    mkdir -p "$HOME_DIR/.local/bin"
    export PATH="$HOME_DIR/.local/bin:$PATH"

    # Install system packages via apt
    echo "Installing system packages..."
    sudo apt update
    sudo apt install -y \
        fd-find fzf htop neovim tmux zsh ranger ripgrep gnupg git \
        ffmpeg ghostscript imagemagick qemu-kvm libvirt-daemon-system \
        libvirt-clients bridge-utils virtinst virt-manager postgresql postgresql-contrib \
        yadm watchman

    # Install Go
    if ! command -v go &>/dev/null; then
        echo "Installing Go..."
        GO_VERSION="1.23.2"
        wget -q https://go.dev/dl/go${GO_VERSION}.linux-amd64.tar.gz
        sudo rm -rf /usr/local/go
        sudo tar -C /usr/local -xzf go${GO_VERSION}.linux-amd64.tar.gz
        export PATH=$PATH:/usr/local/go/bin
        echo 'export PATH=$PATH:/usr/local/go/bin' >> "$HOME_DIR/.bashrc"
        echo 'export PATH=$PATH:/usr/local/go/bin' >> "$HOME_DIR/.zshrc"
        source "$HOME_DIR/.bashrc" || source "$HOME_DIR/.zshrc" || true
    fi

    # Python tools
    echo "Installing Python packages..."
    pip3 install --user \
        black isort fastapi uvicorn python-lsp-server ruff visidata \
        pyright pipx jsonlint

    # Install additional Python tools via pipx
    if command -v pipx &>/dev/null; then
        echo "Installing Python tools via pipx..."
        pipx install git-filter-repo
    fi

    # Node / pnpm tools
    echo "Installing Node tools with pnpm..."
    
    # Ensure pnpm environment is available
    export PNPM_HOME="$HOME_DIR/.local/share/pnpm"
    export PATH="$PNPM_HOME:$PATH"
    
    # Install opencode using recommended method
    if ! command -v opencode &>/dev/null; then
        echo "Installing OpenCode..."
        curl -fsSL https://opencode.ai/install | bash -
    fi
    
    # Install other tools with pnpm
    pnpm add -g \
        prettier @fsouza/prettierd typescript-language-server yaml-language-server \
        @fsouza/prettierd markdownlint-cli @supabase/supabase-js


    # Binary tools helper
    install_bin() {
        url="$1"
        name="$2"
        dest="$HOME_DIR/.local/bin/$name"
        if ! command -v "$name" &>/dev/null; then
            tmp=$(mktemp)
            tmpdir=$(mktemp -d)
            
            echo "Downloading $name..."
            curl -sSL "$url" -o "$tmp"
            
            # Check if it's a tar.gz archive
            if [[ "$url" == *.tar.gz ]]; then
                echo "Extracting $name..."
                tar -xzf "$tmp" -C "$tmpdir"
                
                # Find the executable in the extracted directory
                executable=$(find "$tmpdir" -type f -name "$name" -executable | head -1)
                if [[ -z "$executable" ]]; then
                    # Try to find any executable with similar name
                    executable=$(find "$tmpdir" -type f -executable | head -1)
                fi
                
                if [[ -n "$executable" ]]; then
                    mv "$executable" "$dest"
                    echo "✅ Installed $name"
                else
                    echo "❌ Could not find executable for $name"
                    rm -rf "$tmpdir" "$tmp"
                    return 1
                fi
            else
                # Direct binary download
                mv "$tmp" "$dest"
                chmod +x "$dest"
                echo "✅ Installed $name"
            fi
            
            rm -rf "$tmpdir" "$tmp"
        else
            echo "✅ $name already installed"
        fi
    }

    # User binaries
    install_bin "https://github.com/jesseduffield/lazygit/releases/download/v0.42.2/lazygit_0.42.2_Linux_x86_64.tar.gz" "lazygit"
    install_bin "https://github.com/JohnnyMorganz/StyLua/releases/download/v2.3.0/stylua-linux-x86_64.zip" "stylua"
    install_bin "https://github.com/supabase/cli/releases/download/v2.51.0/supabase_linux_amd64.tar.gz" "supabase"
    install_bin "https://github.com/errata-ai/vale/releases/download/v3.12.0/vale_3.12.0_Linux_64-bit.tar.gz" "vale"
    install_bin "https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp" "yt-dlp"
    install_bin "https://github.com/ajeetdsouza/zoxide/releases/download/v0.9.8/zoxide-0.9.8-x86_64-unknown-linux-musl.tar.gz" "zoxide"
    install_bin "https://github.com/mattn/efm-langserver/releases/download/v0.0.54/efm-langserver_v0.0.54_linux_amd64.tar.gz" "efm-langserver"
    install_bin "https://github.com/superfly/flyctl/releases/download/v0.3.195/flyctl_0.3.195_Linux_x86_64.tar.gz" "flyctl"
    install_bin "https://github.com/artempyanykh/marksman/releases/download/2024-12-18/marksman-linux-x64" "marksman"
    # Install mongosh using official MongoDB repository
    if ! command -v "mongosh" &>/dev/null; then
        echo "Installing mongosh..."
        # Import MongoDB public key
        wget -qO- https://www.mongodb.org/static/pgp/server-8.0.asc | sudo tee /etc/apt/trusted.gpg.d/server-8.0.asc > /dev/null
        # Add MongoDB repository
        echo "deb [ arch=amd64,arm64 ] https://repo.mongodb.org/apt/ubuntu jammy/mongodb-org/8.0 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-8.0.list > /dev/null
        # Update package list and install mongosh
        sudo apt-get update
        sudo apt-get install -y mongodb-mongosh
        echo "✅ Installed mongosh"
    fi
    install_bin "https://github.com/jgm/pandoc/releases/download/3.8.2/pandoc-3.8.2-linux-amd64.tar.gz" "pandoc"
    install_bin "https://github.com/charmbracelet/gum/releases/download/v0.17.0/gum_0.17.0_Linux_x86_64.tar.gz" "gum"
    install_bin "https://github.com/tsenart/vegeta/releases/download/v12.12.0/vegeta_linux_amd64.tar.gz" "vegeta"
    # wrk needs to be built from source since it doesn't have releases
    if ! command -v "wrk" &>/dev/null; then
        echo "Installing wrk..."
        wrk_dir="$HOME_DIR/.local/src/wrk"
        mkdir -p "$wrk_dir"
        git clone https://github.com/wg/wrk.git "$wrk_dir"
        cd "$wrk_dir"
        make
        ln -sf "$wrk_dir/wrk" "$HOME_DIR/.local/bin/wrk"
        cd - > /dev/null
        echo "✅ Installed wrk"
    fi
    
    # Install turso using official installer
    if ! command -v "turso" &>/dev/null; then
        echo "Installing turso..."
        curl --proto '=https' --tlsv1.2 -LsSf https://github.com/tursodatabase/turso/releases/latest/download/turso_cli-installer.sh | sh
        echo "✅ Installed turso"
    fi

    # Install Lua language server
    if ! command -v "lua-language-server" &>/dev/null; then
        echo "Installing Lua language server..."
        mkdir -p "$HOME_DIR/.local/lua-language-server"
        cd "$HOME_DIR/.local/lua-language-server"
        wget -q https://github.com/LuaLS/lua-language-server/releases/download/v3.9.3/lua-language-server-3.9.3-linux-x64.tar.gz
        tar -xzf lua-language-server-3.9.3-linux-x64.tar.gz
        ln -sf "$HOME_DIR/.local/lua-language-server/bin/lua-language-server" "$HOME_DIR/.local/bin/lua-language-server"
        cd - > /dev/null
    fi

    # Create symlinks for tools with different names
    if command -v fdfind &>/dev/null && ! command -v fd &>/dev/null; then
        ln -sf "$(which fdfind)" "$HOME_DIR/.local/bin/fd"
    fi

fi

# -------------------------------
# Oh My Zsh for both OS
# -------------------------------
if [ ! -d "$HOME_DIR/.oh-my-zsh" ]; then
    echo "Installing Oh My Zsh..."
    RUNZSH=no sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)"
fi

# -------------------------------
# Powerlevel10k for both OS
# -------------------------------
if [ ! -d "$HOME_DIR/.powerlevel10k" ]; then
    echo "Installing powerlevel10k..."
    git clone --depth=1 https://github.com/romkatv/powerlevel10k.git "$HOME_DIR/.powerlevel10k"
fi

# -------------------------------
# Add local bin to PATH in shell rc
# -------------------------------
for shell_rc in "$HOME_DIR/.bashrc" "$HOME_DIR/.zshrc"; do
    if [ -f "$shell_rc" ] && ! grep -q ".local/bin" "$shell_rc"; then
        echo 'export PATH="$HOME/.local/bin:$PATH"' >> "$shell_rc"
    fi
    if [ -f "$shell_rc" ] && ! grep -q ".npm-global/bin" "$shell_rc"; then
        echo 'export PATH="$HOME/.npm-global/bin:$PATH"' >> "$shell_rc"
    fi
    if [ -f "$shell_rc" ] && ! grep -q "pnpm" "$shell_rc"; then
        echo 'export PNPM_HOME="$HOME/.local/share/pnpm"' >> "$shell_rc"
        echo 'export PATH="$PNPM_HOME:$PATH"' >> "$shell_rc"
    fi
done

echo "🎉 Dev environment setup complete for $USER_NAME on $OS!"
